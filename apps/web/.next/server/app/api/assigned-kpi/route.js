"use strict";(()=>{var e={};e.id=2299,e.ids=[2299],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},21820:e=>{e.exports=require("os")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},49181:(e,r,s)=>{s.r(r),s.d(r,{patchFetch:()=>k,routeModule:()=>u,serverHooks:()=>c,workAsyncStorage:()=>_,workUnitAsyncStorage:()=>m});var i={};s.r(i),s.d(i,{GET:()=>o,POST:()=>l});var t=s(31453),a=s(91306),n=s(71817),p=s(56492),d=s(3998);async function o(e){try{let r=new URL(e.url),s=r.searchParams.get("department_id"),i=r.searchParams.get("pillar_id"),t={};if(i&&(t.pillar_id=Number(i)),s){let e=(await d.prisma.pillars.findMany({where:{department_id:Number(s)},select:{pillar_id:!0}})).map(e=>e.pillar_id);if(i){if(!e.includes(Number(i)))return p.NextResponse.json({success:!1,error:`Pillar ID ${i} does not belong to Department ID ${s}`},{status:400})}else t.pillar_id={in:e}}let a=await d.prisma.assigned_kpi.findMany({where:t,include:{pillar:{include:{department:!0}}}}),n=[...new Set(a.map(e=>e.kpi_name))],o=await d.prisma.kpi.findMany({where:{kpi_name:{in:n}},select:{kpi_id:!0,kpi_name:!0}}),l={};o.forEach(e=>{l[e.kpi_name]=e.kpi_id});let u=a.map(e=>({assigned_kpi_id:e.assigned_kpi_id,pillar_id:e.pillar_id,kpi_name:e.kpi_name,kpi_status:e.kpi_status,added_date:e.added_date,resolved_date:e.resolved_date,comments:e.comments,kpi_value:e.kpi_value,kpi_description:e.kpi_description,form_input:e.form_input,pillar:e.pillar,department:e.pillar.department,id:`assigned-${e.assigned_kpi_id}`,elements:e.form_data,original_kpi_id:l[e.kpi_name]||null}));return p.NextResponse.json({success:!0,assignedKpis:u})}catch(e){return console.error("Error fetching assigned KPIs:",e),p.NextResponse.json({success:!1,error:"Failed to fetch assigned KPIs"},{status:500})}}async function l(e){try{let{departmentId:r,pillarId:s,kpiIds:i,kpi_name:t,kpi_status:a,kpi_value:n,kpi_description:o,comments:l,form_input:u}=await e.json();if(!r)return p.NextResponse.json({success:!1,error:"Department ID is required"},{status:400});if(!s)return p.NextResponse.json({success:!1,error:"Pillar ID is required"},{status:400});if(!i||!Array.isArray(i)||0===i.length)return p.NextResponse.json({success:!1,error:"At least one KPI ID is required"},{status:400});if(!await d.prisma.pillars.findFirst({where:{pillar_id:Number(s),department_id:Number(r)}}))return p.NextResponse.json({success:!1,error:`Pillar ID ${s} does not belong to Department ID ${r}`},{status:404});let _=(await d.prisma.pillars.findMany({where:{department_id:Number(r)},select:{pillar_id:!0}})).map(e=>e.pillar_id),m=[];for(let e of i){let i=await d.prisma.kpi.findUnique({where:{kpi_id:Number(e)}});if(!i)return p.NextResponse.json({success:!1,error:`KPI template with ID ${e} not found`},{status:404});let c=t||i.kpi_name,k=await d.prisma.assigned_kpi.findFirst({where:{kpi_name:c,pillar_id:{in:_}},include:{pillar:!0}});if(k)return p.NextResponse.json({success:!1,error:`KPI "${c}" is already assigned to pillar "${k.pillar.pillar_name}" in Department ID ${r}`},{status:409});let f=await d.prisma.assigned_kpi.create({data:{pillar_id:Number(s),kpi_name:c,kpi_status:a||"Not Started",form_data:i.form_data,added_date:new Date,resolved_date:null,comments:l||"",kpi_value:void 0!==n?n:i.kpi_value,kpi_description:o||i.kpi_description||"",form_input:u||null},include:{pillar:{include:{department:!0}}}});m.push({assigned_kpi_id:f.assigned_kpi_id,pillar_id:f.pillar_id,kpi_name:f.kpi_name,kpi_status:f.kpi_status,added_date:f.added_date,resolved_date:f.resolved_date,comments:f.comments,kpi_value:f.kpi_value,kpi_description:f.kpi_description,form_input:f.form_input,department:f.pillar.department,pillar:f.pillar,id:`assigned-${f.assigned_kpi_id}`,elements:f.form_data})}return p.NextResponse.json({success:!0,message:`Successfully assigned ${m.length} KPI(s)`,assignedKpis:m})}catch(e){if(console.error("Error assigning KPI(s):",e),e instanceof Error)return p.NextResponse.json({success:!1,error:`Failed to assign KPI(s): ${e.message}`},{status:500});return p.NextResponse.json({success:!1,error:"Failed to assign KPI(s)"},{status:500})}}let u=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/assigned-kpi/route",pathname:"/api/assigned-kpi",filename:"route",bundlePath:"app/api/assigned-kpi/route"},resolvedPagePath:"/Users/vverma/ERP/ERP-SYS/apps/web/app/api/assigned-kpi/route.ts",nextConfigOutput:"",userland:i}),{workAsyncStorage:_,workUnitAsyncStorage:m,serverHooks:c}=u;function k(){return(0,n.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:m})}},55511:e=>{e.exports=require("crypto")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},79646:e=>{e.exports=require("child_process")},79748:e=>{e.exports=require("fs/promises")},83997:e=>{e.exports=require("tty")},84297:e=>{e.exports=require("async_hooks")},94735:e=>{e.exports=require("events")}};var r=require("../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),i=r.X(0,[3747,3332,2302],()=>s(49181));module.exports=i})();